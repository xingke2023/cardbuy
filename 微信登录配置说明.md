# 微信登录配置说明

## ✅ 已完成的工作

### 1. Laravel 后端
- ✅ 创建微信登录 API 接口：`POST /api/v1/wechat/login`
- ✅ 添加 session_key 字段到数据库
- ✅ 支持通过 openid 自动注册新用户
- ✅ 生成 API Token 用于后续认证

### 2. 小程序前端
- ✅ 添加"微信一键登录"按钮
- ✅ 调用 `wx.login()` 获取 code
- ✅ 将 code 发送到后端换取 Token
- ✅ 自动跳转到主页

---

## 🔧 配置步骤

### 第一步：填写微信小程序配置

打开 Laravel 项目的 `.env` 文件，找到以下配置并填入你的信息：

```bash
# 微信小程序配置
WECHAT_MINI_PROGRAM_APPID=your_appid_here      # ← 填入你的 AppID
WECHAT_MINI_PROGRAM_SECRET=your_secret_here    # ← 填入你的 AppSecret
```

### 获取 AppID 和 AppSecret

1. 登录 [微信小程序管理后台](https://mp.weixin.qq.com)
2. 进入 **开发 > 开发管理 > 开发设置**
3. 复制 **AppID** 和 **AppSecret**

### 第二步：重启 Laravel 服务器

修改 `.env` 后需要重启：

```bash
# 停止当前服务器（Ctrl+C）
# 然后重新启动
php artisan serve --port=8001
```

### 第三步：在小程序中测试

1. 打开微信开发者工具
2. 点击"编译"
3. 在登录页面点击 **"微信一键登录"** 按钮
4. 首次登录会自动创建账号

---

## 📝 工作流程

```
1. 用户点击"微信一键登录"
            ↓
2. 小程序调用 wx.login() 获取 code
            ↓
3. 小程序发送 code 到 Laravel 后端
            ↓
4. Laravel 调用微信 API 验证 code，获取 openid
            ↓
5. Laravel 查找或创建用户（通过 openid）
            ↓
6. Laravel 生成 Token 返回给小程序
            ↓
7. 小程序保存 Token，跳转到首页
```

---

## 🎯 API 接口文档

### 微信登录接口

**请求**
```http
POST /api/v1/wechat/login
Content-Type: application/json

{
  "code": "微信登录返回的 code"
}
```

**成功响应**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 4,
      "name": "微信用户",
      "email": "oMxxxxxx@wechat.cardbase.com",
      "wechat": "oMxxxxxx",
      "user_type": "customer",
      ...
    },
    "token": "6|xxxxxxxxxxx",
    "is_new_user": true
  },
  "message": "登录成功"
}
```

**失败响应**
```json
{
  "success": false,
  "message": "微信登录失败: invalid code"
}
```

---

## 🔐 安全说明

### 用户数据存储

微信登录的用户会自动创建，信息存储在 `users` 表：

| 字段 | 说明 | 示例 |
|------|------|------|
| name | 默认昵称 | "微信用户" |
| email | 临时邮箱 | "oMxxxxxx@wechat.cardbase.com" |
| wechat | 微信 openid | "oMxxxxxx" |
| session_key | 微信会话密钥 | "xxx..." |
| password | 随机密码 | Hash::make(random) |

### OpenID 说明

- OpenID 是微信用户的唯一标识
- 同一用户在同一小程序中的 OpenID 不变
- 不同小程序的 OpenID 不同
- OpenID 存储在 `users.wechat` 字段

---

## 🆕 新用户处理

首次微信登录会创建新用户，可以在代码中判断：

```javascript
// 小程序中
if (res.data.data.is_new_user) {
  // 引导用户完善资料
  wx.showModal({
    title: '欢迎',
    content: '首次登录，是否完善资料？',
    success: (res) => {
      if (res.confirm) {
        // 跳转到资料编辑页面
      }
    }
  })
}
```

---

## 🔄 绑定手机号（可选）

如果需要获取用户手机号，可以使用微信提供的手机号授权：

### API 接口
```http
POST /api/v1/user/bind-phone
Authorization: Bearer {token}
Content-Type: application/json

{
  "phone": "13800138000"
}
```

### 小程序代码
```xml
<button open-type="getPhoneNumber" bindgetphonenumber="getPhoneNumber">
  获取手机号
</button>
```

```javascript
getPhoneNumber(e) {
  if (e.detail.errMsg === 'getPhoneNumber:ok') {
    // 发送到后端解密
    wx.request({
      url: app.globalData.apiBase + '/user/bind-phone',
      method: 'POST',
      header: {
        'Authorization': 'Bearer ' + wx.getStorageSync('token')
      },
      data: {
        encryptedData: e.detail.encryptedData,
        iv: e.detail.iv
      }
    })
  }
}
```

---

## 📊 数据库变更

新增字段：

```sql
ALTER TABLE `users` ADD COLUMN `session_key` VARCHAR(100) NULL COMMENT '微信 session_key' AFTER `wechat`;
```

已通过迁移文件自动添加。

---

## 🐛 常见问题

### Q1: 提示"invalid code"？
A: code 只能使用一次，5分钟内有效。确保不要重复发送同一个 code。

### Q2: AppID 和 AppSecret 在哪里？
A: 登录微信小程序后台 → 开发 → 开发管理 → 开发设置

### Q3: 测试时一直提示网络错误？
A:
1. 检查 `.env` 中的 AppID 和 Secret 是否正确
2. 确认 Laravel 服务器正在运行
3. 查看 Laravel 日志：`storage/logs/laravel.log`

### Q4: 如何区分微信登录和账号登录的用户？
A: 查看 `users.wechat` 字段，有值的是微信登录用户。

### Q5: 微信用户可以绑定邮箱吗？
A: 可以！让用户在个人资料中填写邮箱，更新 `users.email` 字段即可。

---

## 📝 测试清单

- [ ] 填写 AppID 和 AppSecret
- [ ] 重启 Laravel 服务器
- [ ] 小程序中点击"微信一键登录"
- [ ] 检查是否成功跳转到首页
- [ ] 查看数据库 users 表是否新增用户
- [ ] 验证 WebView 中是否已登录

---

## 🎉 完成！

现在你的小程序已经支持：
- ✅ 邮箱账号登录
- ✅ 微信一键登录
- ✅ 自动注册新用户
- ✅ 统一的 Token 认证

用户可以选择任意方式登录，都能正常使用所有功能！
